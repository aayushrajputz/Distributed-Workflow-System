<!DOCTYPE html>
<html>
<head>
    <title>Test System Metrics & Distributed Nodes</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 20px auto; padding: 20px; }
        .test-section { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .info { background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 4px; margin: 10px 0; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; font-size: 12px; max-height: 300px; overflow-y: auto; }
        input { width: 300px; padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .metric-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9; }
        .metric-value { font-size: 24px; font-weight: bold; color: #007bff; }
        .metric-label { font-size: 14px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>üîß Test System Metrics & Distributed Nodes</h1>
    <p>This will test the Prometheus metrics and distributed nodes endpoints.</p>

    <div class="test-section">
        <h2>üîê Step 1: Login & Get API Key</h2>
        <input type="email" id="email" placeholder="Email" value="aayushpratap001@gmail.com">
        <input type="password" id="password" placeholder="Password" value="FixTest123!">
        <button onclick="testLogin()">Login</button>
        <button onclick="getApiKey()">Get API Key</button>
        <div id="loginResult"></div>
    </div>

    <div class="test-section">
        <h2>üìä Step 2: Test System Metrics</h2>
        <button onclick="testSystemMetrics()">Test System Metrics</button>
        <div id="systemMetricsResult"></div>
        <div id="systemMetricsDisplay" class="metrics-grid"></div>
    </div>

    <div class="test-section">
        <h2>üåê Step 3: Test Distributed Nodes</h2>
        <button onclick="testDistributedNodes()">Test Distributed Nodes</button>
        <div id="distributedNodesResult"></div>
        <div id="distributedNodesDisplay"></div>
    </div>

    <div class="test-section">
        <h2>üîÑ Step 4: Test Real-Time Updates</h2>
        <button onclick="startRealTimeTest()" id="realTimeBtn">Start Real-Time Test</button>
        <button onclick="stopRealTimeTest()" id="stopBtn" disabled>Stop Test</button>
        <div id="realTimeResult"></div>
    </div>

    <script>
        let authToken = '';
        let apiKey = '';
        let realTimeInterval = null;

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = type;
            element.innerHTML = `<pre>${message}</pre>`;
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                showResult('loginResult', 'Testing login...', 'info');
                
                const response = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Login failed: ${error.message}`);
                }

                const data = await response.json();
                authToken = data.token;

                showResult('loginResult', `‚úÖ Login successful!
User: ${data.user.email}
Token: ${authToken.substring(0, 20)}...
Ready for API key generation!`, 'success');

            } catch (error) {
                showResult('loginResult', `‚ùå Login failed: ${error.message}`, 'error');
            }
        }

        async function getApiKey() {
            if (!authToken) {
                showResult('loginResult', '‚ùå Please login first', 'error');
                return;
            }

            try {
                showResult('loginResult', 'Getting API key...', 'info');
                
                const response = await fetch('http://localhost:5000/api/api-keys', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok && result.data.length > 0) {
                    apiKey = result.data[0].key;
                    localStorage.setItem('apiKey', apiKey);
                    
                    showResult('loginResult', `‚úÖ API Key retrieved!
Key: ${apiKey.substring(0, 20)}...
Stored in localStorage for metrics access!`, 'success');
                } else {
                    // Create a new API key
                    const createResponse = await fetch('http://localhost:5000/api/api-keys', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: 'Test Metrics Key',
                            description: 'API key for testing system metrics'
                        })
                    });

                    const createResult = await createResponse.json();
                    if (createResponse.ok) {
                        apiKey = createResult.data.key;
                        localStorage.setItem('apiKey', apiKey);
                        
                        showResult('loginResult', `‚úÖ New API Key created!
Key: ${apiKey.substring(0, 20)}...
Stored in localStorage for metrics access!`, 'success');
                    } else {
                        throw new Error(`Failed to create API key: ${createResult.message}`);
                    }
                }

            } catch (error) {
                showResult('loginResult', `‚ùå API Key error: ${error.message}`, 'error');
            }
        }

        async function testSystemMetrics() {
            if (!apiKey) {
                showResult('systemMetricsResult', '‚ùå Please get API key first', 'error');
                return;
            }

            try {
                showResult('systemMetricsResult', 'Testing system metrics...', 'info');
                
                const response = await fetch('http://localhost:5000/api/v1/metrics/system', {
                    headers: {
                        'X-API-Key': apiKey,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    const metrics = result.data;
                    
                    showResult('systemMetricsResult', `‚úÖ System metrics working!
Response: ${JSON.stringify(metrics, null, 2)}`, 'success');

                    // Display metrics in a nice format
                    const metricsDisplay = document.getElementById('systemMetricsDisplay');
                    metricsDisplay.innerHTML = `
                        <div class="metric-card">
                            <div class="metric-value">${metrics.cpu_usage?.toFixed(1) || 'N/A'}%</div>
                            <div class="metric-label">CPU Usage</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${metrics.memory_usage?.toFixed(1) || 'N/A'}%</div>
                            <div class="metric-label">Memory Usage</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${metrics.disk_usage?.toFixed(1) || 'N/A'}%</div>
                            <div class="metric-label">Disk Usage</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${metrics.requests_per_second?.toFixed(1) || 'N/A'}</div>
                            <div class="metric-label">Requests/Second</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${metrics.active_connections || 'N/A'}</div>
                            <div class="metric-label">Active Connections</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${metrics.active_api_keys || 'N/A'}</div>
                            <div class="metric-label">Active API Keys</div>
                        </div>
                    `;
                } else {
                    showResult('systemMetricsResult', `‚ùå System metrics failed: ${result.message}`, 'error');
                }

            } catch (error) {
                showResult('systemMetricsResult', `‚ùå System metrics error: ${error.message}`, 'error');
            }
        }

        async function testDistributedNodes() {
            if (!apiKey) {
                showResult('distributedNodesResult', '‚ùå Please get API key first', 'error');
                return;
            }

            try {
                showResult('distributedNodesResult', 'Testing distributed nodes...', 'info');
                
                const response = await fetch('http://localhost:5000/api/v1/metrics/nodes', {
                    headers: {
                        'X-API-Key': apiKey,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    const data = result.data;
                    
                    showResult('distributedNodesResult', `‚úÖ Distributed nodes working!
Total Nodes: ${data.total_nodes}
Healthy: ${data.healthy_nodes}
Warning: ${data.warning_nodes}
Critical: ${data.critical_nodes}`, 'success');

                    // Display nodes in a nice format
                    const nodesDisplay = document.getElementById('distributedNodesDisplay');
                    nodesDisplay.innerHTML = `
                        <h4>Node Status Overview</h4>
                        <div class="metrics-grid">
                            ${data.nodes.map(node => `
                                <div class="metric-card">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <strong>${node.name}</strong>
                                        <span style="color: ${node.status === 'healthy' ? 'green' : node.status === 'warning' ? 'orange' : 'red'}">
                                            ${node.status.toUpperCase()}
                                        </span>
                                    </div>
                                    <div style="margin: 10px 0;">
                                        <div>Region: ${node.region}</div>
                                        <div>CPU: ${node.cpu_usage?.toFixed(1)}%</div>
                                        <div>Memory: ${node.memory_usage?.toFixed(1)}%</div>
                                        <div>Services: ${node.services.join(', ')}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    showResult('distributedNodesResult', `‚ùå Distributed nodes failed: ${result.message}`, 'error');
                }

            } catch (error) {
                showResult('distributedNodesResult', `‚ùå Distributed nodes error: ${error.message}`, 'error');
            }
        }

        async function startRealTimeTest() {
            if (!apiKey) {
                showResult('realTimeResult', '‚ùå Please get API key first', 'error');
                return;
            }

            document.getElementById('realTimeBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            showResult('realTimeResult', 'Starting real-time metrics test...', 'info');

            let updateCount = 0;
            realTimeInterval = setInterval(async () => {
                updateCount++;
                try {
                    const [systemResponse, nodesResponse] = await Promise.all([
                        fetch('http://localhost:5000/api/v1/metrics/system', {
                            headers: { 'X-API-Key': apiKey }
                        }),
                        fetch('http://localhost:5000/api/v1/metrics/nodes', {
                            headers: { 'X-API-Key': apiKey }
                        })
                    ]);

                    const systemData = await systemResponse.json();
                    const nodesData = await nodesResponse.json();

                    showResult('realTimeResult', `üîÑ Real-time update #${updateCount}
System Metrics: ${systemResponse.ok ? '‚úÖ' : '‚ùå'}
- CPU: ${systemData.data?.cpu_usage?.toFixed(1)}%
- Memory: ${systemData.data?.memory_usage?.toFixed(1)}%
- RPS: ${systemData.data?.requests_per_second?.toFixed(1)}

Distributed Nodes: ${nodesResponse.ok ? '‚úÖ' : '‚ùå'}
- Total: ${nodesData.data?.total_nodes}
- Healthy: ${nodesData.data?.healthy_nodes}
- Warning: ${nodesData.data?.warning_nodes}

Last Update: ${new Date().toLocaleTimeString()}`, 'success');

                } catch (error) {
                    showResult('realTimeResult', `‚ùå Real-time update #${updateCount} failed: ${error.message}`, 'error');
                }
            }, 5000);
        }

        function stopRealTimeTest() {
            if (realTimeInterval) {
                clearInterval(realTimeInterval);
                realTimeInterval = null;
            }
            
            document.getElementById('realTimeBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            showResult('realTimeResult', '‚èπÔ∏è Real-time test stopped', 'info');
        }
    </script>
</body>
</html>
